# Middleware

## Опис модуля

Модуль `middleware` забезпечує обробку авторизації для різних ролей користувачів у застосунку (admin, worker, user). Він перевіряє токен, отриманий від клієнта, і надає доступ до ресурсів відповідно до ролі користувача.

---

## Основні компоненти

### Структура `Middleware`

```go
type Middleware struct {
    srv *service.Service // Сервіс для взаємодії з логікою авторизації
}
```

- **`srv`**: Інстанс сервісу, який використовується для розбору та перевірки токенів через `AuthServices`.

### Конструктор `NewMiddleware`

Ініціалізує Middleware з наданим сервісом:

```go
func NewMiddleware(srv *service.Service) *Middleware
```

---

## Основні функції

### `AuthMiddleware`

Перевіряє, чи токен користувача дійсний, і дозволяє доступ для ролей `user`, `worker`, або `admin`:

```go
func (m *Middleware) AuthMiddleware(c fiber.Ctx) error
```

- **Ключові перевірки:**
    - Токен переданий у cookie.
    - Токен дійсний і може бути розібраний.
    - Роль токена відповідає дозволеним (`user`, `worker`, `admin`).
- **Додає в контекст локальні змінні:**
    - `userId`: ID користувача.
    - `userRole`: Роль користувача.

---

### `AdminAuthMiddleware`

Перевіряє токен і дозволяє доступ тільки для ролі `admin`:

```go
func (m *Middleware) AdminAuthMiddleware(c fiber.Ctx) error
```

- **Ключові перевірки:**
    - Токен переданий у cookie.
    - Токен дійсний і може бути розібраний.
    - Роль токена повинна бути `admin`.
- **Додає в контекст локальні змінні:**
    - `userId`: ID адміністратора.
    - `userRole`: Роль користувача (перевірено на `admin`).

---

### `WorkerAuthMiddleware`

Перевіряє токен і дозволяє доступ тільки для ролі `worker`:

```go
func (m *Middleware) WorkerAuthMiddleware(c fiber.Ctx) error
```

- **Ключові перевірки:**
    - Токен переданий у cookie.
    - Токен дійсний і може бути розібраний.
    - Роль токена повинна бути `worker`.
- **Додає в контекст локальні змінні:**
    - `userId`: ID працівника.
    - `userRole`: Роль користувача (перевірено на `worker`).

---

## Логіка роботи

1. **Отримання токена**:

    - Токен береться з cookie з назвою `token`.
    - Якщо токен відсутній, повертається помилка `Unauthorized`.

2. **Розбір токена**:

    - Токен перевіряється через `AuthServices.ParseToken`, що повертає `userId`, `userRole` або помилку.

3. **Валідація ролі**:

    - Залежно від middleware, перевіряється, чи роль користувача відповідає очікуваній ролі (`user`, `worker`, `admin`).

4. **Додавання контексту**:

    - У разі успішної перевірки до контексту `fiber.Ctx` додаються локальні змінні `userId` та `userRole`, які можна використовувати в подальших обробниках запитів.

5. **Передача запиту далі**:

    - Якщо всі перевірки успішні, викликається метод `c.Next()`, що дозволяє передати обробку запиту наступному middleware або маршруту.

---

## Помилки

### Потенційні помилки

1. **`401 Unauthorized`**:
    - Токен відсутній або недійсний.
    - Наприклад: `"Invalid token: empty token"`.

2. **`403 Forbidden`**:
    - Невідповідна роль користувача для доступу.
    - Наприклад: `"Invalid token: invalid role, expected admin got user"`.

### Як обробляються помилки

Усі помилки повертаються у вигляді HTTP-відповідей з відповідним статус-кодом (`401` або `403`) і повідомленням, що пояснює проблему.

---

## Приклади використання

### Підключення Middleware до маршруту

#### Для авторизації всіх користувачів:

```go
app.Get("/user/profile", middleware.AuthMiddleware, handler.GetUserProfile)
```

#### Для адміністратора:

```go
app.Post("/admin/add", middleware.AdminAuthMiddleware, handler.AddDish)
```

#### Для працівників:

```go
app.Get("/worker/tasks", middleware.WorkerAuthMiddleware, handler.GetWorkerTasks)
```

